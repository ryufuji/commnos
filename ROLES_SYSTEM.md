# ãƒ­ãƒ¼ãƒ«ï¼ˆå½¹å‰²ï¼‰ã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°èª¬æ˜

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãŠã‘ã‚‹**3ã¤ã®ãƒ­ãƒ¼ãƒ«**ã®å®šç¾©ã€é–¢ä¿‚æ€§ã€æ¨©é™ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ­ 3ã¤ã®ãƒ­ãƒ¼ãƒ«

ã¯ã„ã€èªè­˜é€šã‚Šã§ã™ã€‚**ç¾çŠ¶ã¯ä»¥ä¸‹ã®3ã¤ã®ãƒ­ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ã¾ã™**ï¼š

| ãƒ­ãƒ¼ãƒ« | è‹±èªè¡¨è¨˜ | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å€¤ | éšå±¤ãƒ¬ãƒ™ãƒ« |
|---|---|---|---|
| **ã‚ªãƒ¼ãƒŠãƒ¼** | Owner | `owner` | 3ï¼ˆæœ€é«˜ï¼‰ |
| **ç®¡ç†è€…** | Admin | `admin` | 2 |
| **ãƒ¡ãƒ³ãƒãƒ¼** | Member | `member` | 1ï¼ˆåŸºæœ¬ï¼‰ |

---

## ğŸ“Š ãƒ­ãƒ¼ãƒ«ã®é–¢ä¿‚æ€§ã¨éšå±¤æ§‹é€ 

### éšå±¤å›³

```
           ğŸ‘‘ Ownerï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰
                  |
          æœ€é«˜æ¨©é™ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ä½œæˆè€…
          è²¡å‹™ç®¡ç†ãƒ»å…¨æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
                  |
                  |
           ğŸ›¡ï¸ Adminï¼ˆç®¡ç†è€…ï¼‰
                  |
          ä¸­é–“ç®¡ç†æ¨©é™ãƒ»ä¼šå“¡ç®¡ç†
          æŠ•ç¨¿ç®¡ç†ãƒ»ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                  |
                  |
           ğŸ‘¤ Memberï¼ˆãƒ¡ãƒ³ãƒãƒ¼ï¼‰
                  |
          åŸºæœ¬æ¨©é™ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å‚åŠ 
          æŠ•ç¨¿ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ã„ã„ã­
```

### æ¨©é™éšå±¤ã‚·ã‚¹ãƒ†ãƒ 

ã‚³ãƒ¼ãƒ‰å†…ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«éšå±¤ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ï¼š

```typescript
const roleHierarchy = { 
  owner: 3,   // æœ€é«˜æ¨©é™
  admin: 2,   // ä¸­é–“æ¨©é™
  member: 1   // åŸºæœ¬æ¨©é™
}
```

**é‡è¦**: ä¸Šä½ã®ãƒ­ãƒ¼ãƒ«ã¯ä¸‹ä½ã®ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’ã™ã¹ã¦æŒã¡ã¾ã™ã€‚
- Owner ã¯ Admin ã¨ Member ã®å…¨æ©Ÿèƒ½ã‚’åˆ©ç”¨å¯èƒ½
- Admin ã¯ Member ã®å…¨æ©Ÿèƒ½ã‚’åˆ©ç”¨å¯èƒ½

---

## ğŸ‘‘ Ownerï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã®è©³ç´°

### å®šç¾©
- **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼**
- **1ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«ã¤ã1äººã®ã¿**
- **å¤‰æ›´ä¸å¯**ï¼ˆä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚ªãƒ¼ãƒŠãƒ¼ã«å¤‰æ›´ã§ããªã„ï¼‰

### ä½œæˆæ–¹æ³•
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ–°è¦ä½œæˆã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ã‚ªãƒ¼ãƒŠãƒ¼ã«ãªã‚Šã¾ã™ï¼š

```sql
-- 1. ãƒ†ãƒŠãƒ³ãƒˆï¼ˆã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼‰ä½œæˆ
INSERT INTO tenants (subdomain, name, owner_user_id, ...)
VALUES ('golf-club', 'ã‚´ãƒ«ãƒ•ã‚¯ãƒ©ãƒ–', user.id, ...)

-- 2. ãƒ†ãƒŠãƒ³ãƒˆãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ä½œæˆï¼ˆowneræ¨©é™ï¼‰
INSERT INTO tenant_memberships (tenant_id, user_id, role, member_number, status)
VALUES (tenant_id, user.id, 'owner', '0', 'active')
```

### ç‰¹å¾´
- **ä¼šå“¡ç•ªå·**: `0`ï¼ˆç‰¹åˆ¥ç•ªå·ï¼‰
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è‡ªå‹•çš„ã« `active`ï¼ˆæ‰¿èªä¸è¦ï¼‰
- **ãƒ†ãƒŠãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®é–¢ä¿‚**: `tenants.owner_user_id` ã«ã‚‚è¨˜éŒ²ã•ã‚Œã‚‹

### ã‚ªãƒ¼ãƒŠãƒ¼å°‚ç”¨ã®æ¨©é™

#### 1. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆå®Œå…¨ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
- âœ… ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®é–²è¦§
- âœ… ãƒ—ãƒ©ãƒ³å¤‰æ›´ï¼ˆFree/Starter/Proï¼‰
- âœ… ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å†é–‹
- âœ… è«‹æ±‚å±¥æ­´ã®é–²è¦§
- âœ… Stripeæ±ºæ¸ˆç®¡ç†

**API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆowner ã®ã¿ï¼‰**:
- `GET /api/subscription/status`
- `POST /api/subscription/change-plan`
- `POST /api/subscription/cancel`
- `POST /api/subscription/reactivate`
- `GET /api/subscription/invoices`

#### 2. ä¼šå“¡ç®¡ç†ï¼ˆAdmin ã¨å…±é€šï¼‰
- âœ… ä¼šå“¡ã®æ‰¿èª/æ‹’å¦
- âœ… ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆactive/suspendedï¼‰
- âœ… ä¼šå“¡å½¹å‰²å¤‰æ›´ï¼ˆmember â‡„ adminï¼‰
  - **æ³¨æ„**: ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã¸ã®å¤‰æ›´ã¯ä¸å¯
- âœ… ä¼šå“¡ã®å‰Šé™¤

#### 3. æŠ•ç¨¿ç®¡ç†ï¼ˆAdmin ã¨å…±é€šï¼‰
- âœ… ã™ã¹ã¦ã®æŠ•ç¨¿ã®ç·¨é›†ãƒ»å‰Šé™¤
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†

#### 4. ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®šï¼ˆowner ã®ã¿ï¼‰
- âœ… ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£åãƒ»èª¬æ˜ã®å¤‰æ›´
- âœ… ãƒ†ãƒ¼ãƒãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- âœ… å…¬é–‹è¨­å®šã®å¤‰æ›´

#### 5. é€šå¸¸ã®ä¼šå“¡æ©Ÿèƒ½ï¼ˆå…¨å“¡å…±é€šï¼‰
- âœ… æŠ•ç¨¿ä½œæˆ
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
- âœ… ã„ã„ã­æ©Ÿèƒ½

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```sql
-- tenants ãƒ†ãƒ¼ãƒ–ãƒ«
owner_user_id INTEGER NOT NULL  -- ã‚ªãƒ¼ãƒŠãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

-- tenant_memberships ãƒ†ãƒ¼ãƒ–ãƒ«
role TEXT NOT NULL DEFAULT 'member'  -- 'owner' | 'admin' | 'member'
member_number TEXT                   -- ã‚ªãƒ¼ãƒŠãƒ¼ã¯ '0'
status TEXT NOT NULL DEFAULT 'pending'  -- ã‚ªãƒ¼ãƒŠãƒ¼ã¯ 'active'
```

---

## ğŸ›¡ï¸ Adminï¼ˆç®¡ç†è€…ï¼‰ã®è©³ç´°

### å®šç¾©
- **ã‚ªãƒ¼ãƒŠãƒ¼ã«ã‚ˆã£ã¦ä»»å‘½ã•ã‚ŒãŸç®¡ç†è€…**
- **è¤‡æ•°äººè¨­å®šå¯èƒ½**
- **ã‚ªãƒ¼ãƒŠãƒ¼ãŒã„ã¤ã§ã‚‚å¤‰æ›´å¯èƒ½**ï¼ˆmember â‡„ adminï¼‰

### ä½œæˆæ–¹æ³•
ã‚ªãƒ¼ãƒŠãƒ¼ãŒæ—¢å­˜ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç®¡ç†è€…ã«æ˜‡æ ¼ï¼š

```typescript
// API: POST /api/admin/members/:id/role
// Body: { role: 'admin' }

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
UPDATE tenant_memberships 
SET role = 'admin'
WHERE id = membership_id AND tenant_id = tenant_id
```

### ç‰¹å¾´
- **ä¼šå“¡ç•ªå·**: `001`, `002`, `003`...ï¼ˆä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã¨åŒã˜ï¼‰
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: `active`
- **å½¹å‰²å¤‰æ›´**: ã‚ªãƒ¼ãƒŠãƒ¼ãŒ `member` â‡„ `admin` ã‚’å¤‰æ›´å¯èƒ½

### Admin ã®æ¨©é™

#### 1. ä¼šå“¡ç®¡ç†ï¼ˆOwner ã¨å…±é€šï¼‰
- âœ… ä¼šå“¡ã®æ‰¿èª/æ‹’å¦ï¼ˆ`GET /api/admin/members/pending`ï¼‰
- âœ… ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆ`POST /api/admin/members/:id/status`ï¼‰
- âœ… ä¼šå“¡å½¹å‰²å¤‰æ›´ï¼ˆ`POST /api/admin/members/:id/role`ï¼‰
  - **åˆ¶é™**: `member` ã¨ `admin` ã®é–“ã®ã¿å¤‰æ›´å¯èƒ½
  - **ä¸å¯**: `owner` ã¸ã®å¤‰æ›´ã¯ä¸å¯
- âœ… ä¼šå“¡ã®å‰Šé™¤ï¼ˆ`DELETE /api/admin/members/:id`ï¼‰

#### 2. æŠ•ç¨¿ç®¡ç†ï¼ˆOwner ã¨å…±é€šï¼‰
- âœ… ã™ã¹ã¦ã®æŠ•ç¨¿ã®ç·¨é›†ãƒ»å‰Šé™¤
- âœ… æŠ•ç¨¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆå…¬é–‹/ä¸‹æ›¸ãï¼‰
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤

#### 3. é€šå¸¸ã®ä¼šå“¡æ©Ÿèƒ½ï¼ˆå…¨å“¡å…±é€šï¼‰
- âœ… æŠ•ç¨¿ä½œæˆ
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
- âœ… ã„ã„ã­æ©Ÿèƒ½

### Admin ãŒæŒãŸãªã„æ¨©é™

#### âŒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
- âŒ ãƒ—ãƒ©ãƒ³å¤‰æ›´
- âŒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- âŒ è«‹æ±‚å±¥æ­´ã®é–²è¦§
- âŒ ä½¿ç”¨çŠ¶æ³ã®ç¢ºèª

**ç†ç”±**: è²¡å‹™æƒ…å ±ã¯ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ãŒç®¡ç†ã™ã¹ãæ©Ÿå¯†æƒ…å ±

#### âŒ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®š
- âŒ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£åãƒ»èª¬æ˜ã®å¤‰æ›´
- âŒ ãƒ†ãƒ¼ãƒãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- âŒ å…¬é–‹è¨­å®šã®å¤‰æ›´

**ç†ç”±**: ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®åŸºæœ¬è¨­å®šã¯ã‚ªãƒ¼ãƒŠãƒ¼ãŒç®¡ç†

#### âŒ ç®¡ç†è€…ã®ä»»å‘½
- âŒ ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç®¡ç†è€…ã«æ˜‡æ ¼
- âŒ è‡ªåˆ†è‡ªèº«ã®å½¹å‰²å¤‰æ›´

**ç†ç”±**: ç®¡ç†è€…ã®ä»»å‘½æ¨©ã¯ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿

---

## ğŸ‘¤ Memberï¼ˆãƒ¡ãƒ³ãƒãƒ¼ï¼‰ã®è©³ç´°

### å®šç¾©
- **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å‚åŠ ã—ãŸä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼**
- **ç„¡åˆ¶é™ã«å‚åŠ å¯èƒ½**ï¼ˆãƒ—ãƒ©ãƒ³ã«ã‚ˆã‚‹ä¸Šé™ã‚ã‚Šï¼‰
- **åŸºæœ¬çš„ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ©Ÿèƒ½ã‚’åˆ©ç”¨**

### ä½œæˆæ–¹æ³•
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å‚åŠ ç”³è«‹ï¼š

```typescript
// API: POST /api/members/join
// Body: { tenant_id: 1 }

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç™»éŒ²
INSERT INTO tenant_memberships (tenant_id, user_id, role, status)
VALUES (tenant_id, user_id, 'member', 'pending')
```

ãã®å¾Œã€ã‚ªãƒ¼ãƒŠãƒ¼ã¾ãŸã¯ç®¡ç†è€…ãŒæ‰¿èªï¼š

```typescript
// API: POST /api/admin/members/:id/approve

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
UPDATE tenant_memberships
SET status = 'active', member_number = '001'
WHERE id = membership_id
```

### ç‰¹å¾´
- **ä¼šå“¡ç•ªå·**: `001`, `002`, `003`...ï¼ˆé€£ç•ªï¼‰
- **åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: `pending`ï¼ˆæ‰¿èªå¾…ã¡ï¼‰
- **æ‰¿èªå¾Œ**: `active`ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¼šå“¡ï¼‰

### Member ã®æ¨©é™

#### 1. æŠ•ç¨¿æ©Ÿèƒ½
- âœ… æŠ•ç¨¿ä½œæˆï¼ˆ`POST /api/posts`ï¼‰
- âœ… è‡ªåˆ†ã®æŠ•ç¨¿ç·¨é›†ï¼ˆ`PUT /api/posts/:id`ï¼‰
  - **åˆ¶é™**: è‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿
- âœ… è‡ªåˆ†ã®æŠ•ç¨¿å‰Šé™¤ï¼ˆ`DELETE /api/posts/:id`ï¼‰
  - **åˆ¶é™**: è‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿
- âœ… æŠ•ç¨¿é–²è¦§ï¼ˆ`GET /api/posts`ï¼‰

#### 2. ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆ`POST /api/posts/:id/comments`ï¼‰
- âœ… è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
  - **åˆ¶é™**: è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆé–²è¦§

#### 3. ã„ã„ã­æ©Ÿèƒ½
- âœ… æŠ•ç¨¿ã«ã„ã„ã­ï¼ˆ`POST /api/likes/:postId`ï¼‰
- âœ… ã„ã„ã­å–ã‚Šæ¶ˆã—ï¼ˆ`DELETE /api/likes/:postId`ï¼‰

#### 4. é€šçŸ¥æ©Ÿèƒ½
- âœ… é€šçŸ¥å—ä¿¡
- âœ… é€šçŸ¥ä¸€è¦§é–²è¦§ï¼ˆ`GET /api/notifications`ï¼‰
- âœ… æ—¢èª­ãƒãƒ¼ã‚¯ï¼ˆ`POST /api/notifications/:id/read`ï¼‰

#### 5. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
- âœ… è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
- âœ… ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

### Member ãŒæŒãŸãªã„æ¨©é™

#### âŒ ä¼šå“¡ç®¡ç†
- âŒ ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®æ‰¿èª/æ‹’å¦
- âŒ ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
- âŒ ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å½¹å‰²å¤‰æ›´
- âŒ ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å‰Šé™¤

#### âŒ æŠ•ç¨¿ç®¡ç†ï¼ˆä»–äººã®æŠ•ç¨¿ï¼‰
- âŒ ä»–äººã®æŠ•ç¨¿ç·¨é›†
- âŒ ä»–äººã®æŠ•ç¨¿å‰Šé™¤
- âŒ ä»–äººã®ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤

#### âŒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
- âŒ ãƒ—ãƒ©ãƒ³æƒ…å ±ã®é–²è¦§
- âŒ ãƒ—ãƒ©ãƒ³å¤‰æ›´
- âŒ è«‹æ±‚å±¥æ­´ã®é–²è¦§

#### âŒ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®š
- âŒ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£åãƒ»èª¬æ˜ã®å¤‰æ›´
- âŒ ãƒ†ãƒ¼ãƒãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

---

## ğŸ”„ ãƒ­ãƒ¼ãƒ«å¤‰æ›´ã®ãƒ•ãƒ­ãƒ¼

### 1. Member â†’ Adminï¼ˆæ˜‡æ ¼ï¼‰

```
1. ã‚ªãƒ¼ãƒŠãƒ¼ãŒç®¡ç†ç”»é¢ã§ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ
   â†“
2. ã€Œç®¡ç†è€…ã«æ˜‡æ ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
3. API å‘¼ã³å‡ºã—: POST /api/admin/members/:id/role
   Body: { role: 'admin' }
   â†“
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°:
   UPDATE tenant_memberships SET role = 'admin' WHERE id = :id
   â†“
5. å®Œäº†: ãƒ¡ãƒ³ãƒãƒ¼ãŒç®¡ç†è€…æ¨©é™ã‚’å–å¾—
```

### 2. Admin â†’ Memberï¼ˆé™æ ¼ï¼‰

```
1. ã‚ªãƒ¼ãƒŠãƒ¼ãŒç®¡ç†ç”»é¢ã§ç®¡ç†è€…ã‚’é¸æŠ
   â†“
2. ã€Œãƒ¡ãƒ³ãƒãƒ¼ã«é™æ ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
3. API å‘¼ã³å‡ºã—: POST /api/admin/members/:id/role
   Body: { role: 'member' }
   â†“
4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°:
   UPDATE tenant_memberships SET role = 'member' WHERE id = :id
   â†“
5. å®Œäº†: ç®¡ç†è€…ãŒãƒ¡ãƒ³ãƒãƒ¼æ¨©é™ã«æˆ»ã‚‹
```

### 3. Owner ã¸ã®å¤‰æ›´ï¼ˆä¸å¯ï¼‰

```
âŒ ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã¸ã®å¤‰æ›´ã¯ä¸å¯èƒ½ã§ã™

ç†ç”±:
1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®æ‰€æœ‰æ¨©ã‚’ä¿è­·
2. è²¬ä»»ã®æ˜ç¢ºåŒ–: ä½œæˆè€…ãŒè²¬ä»»ã‚’æŒã¤
3. è²¡å‹™ç®¡ç†: æ”¯æ‰•ã„è²¬ä»»ã®æ‰€åœ¨ã‚’æ˜ç¢ºåŒ–

ä»£æ›¿æ¡ˆ:
- æ–°ã—ã„ã‚ªãƒ¼ãƒŠãƒ¼ãŒã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’ä½œæˆ
- æ—¢å­˜ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
```

---

## ğŸ¯ å®Ÿè£…ã®è©³ç´°

### æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ã‚³ãƒ¼ãƒ‰ä¾‹

#### 1. éšå±¤ãƒã‚§ãƒƒã‚¯ï¼ˆrequireRoleï¼‰

```typescript
// ç‰¹å®šã®å½¹å‰²ä»¥ä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
export function requireRole(requiredRole: 'owner' | 'admin' | 'member') {
  return async (c, next) => {
    const role = c.get('role')
    const roleHierarchy = { owner: 3, admin: 2, member: 1 }

    const userRoleLevel = roleHierarchy[role] || 0
    const requiredRoleLevel = roleHierarchy[requiredRole] || 0

    if (userRoleLevel < requiredRoleLevel) {
      return c.json({ success: false, error: 'Insufficient permissions' }, 403)
    }

    await next()
  }
}

// ä½¿ç”¨ä¾‹
app.get('/api/subscription/status', authMiddleware, requireRole('owner'), ...)
// â†’ owner ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

app.get('/api/admin/members', authMiddleware, requireRole('admin'), ...)
// â†’ owner ã¨ admin ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆéšå±¤çš„ï¼‰
```

#### 2. ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆroleMiddlewareï¼‰

```typescript
// æŒ‡å®šã•ã‚ŒãŸå½¹å‰²ã®ã„ãšã‚Œã‹ã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
export function roleMiddleware(allowedRoles: ('owner' | 'admin' | 'member')[]) {
  return async (c, next) => {
    const role = c.get('role')

    if (!allowedRoles.includes(role)) {
      return c.json({ success: false, error: 'Insufficient permissions' }, 403)
    }

    await next()
  }
}

// ä½¿ç”¨ä¾‹
app.post('/api/posts', authMiddleware, roleMiddleware(['owner', 'admin']), ...)
// â†’ owner ã¨ admin ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆå³å¯†ï¼‰
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªä¾‹

#### ãƒ­ãƒ¼ãƒ«å–å¾—

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹å®šã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®å½¹å‰²ã‚’å–å¾—
SELECT role, status, member_number
FROM tenant_memberships
WHERE tenant_id = ? AND user_id = ?
```

#### ãƒ­ãƒ¼ãƒ«å¤‰æ›´

```sql
-- ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç®¡ç†è€…ã«æ˜‡æ ¼
UPDATE tenant_memberships
SET role = 'admin'
WHERE id = ? AND tenant_id = ?
```

#### ã‚ªãƒ¼ãƒŠãƒ¼ç¢ºèª

```sql
-- ãƒ†ãƒŠãƒ³ãƒˆã®ã‚ªãƒ¼ãƒŠãƒ¼ã‚’ç¢ºèª
SELECT tm.*, u.email, u.nickname
FROM tenant_memberships tm
JOIN users u ON tm.user_id = u.id
WHERE tm.tenant_id = ? AND tm.role = 'owner'
```

---

## ğŸ“‹ æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ï¼ˆå®Œå…¨ç‰ˆï¼‰

| æ©Ÿèƒ½ | Owner | Admin | Member |
|---|:---:|:---:|:---:|
| **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†** | | | |
| ãƒ—ãƒ©ãƒ³æƒ…å ±é–²è¦§ | âœ… | âŒ | âŒ |
| ãƒ—ãƒ©ãƒ³å¤‰æ›´ | âœ… | âŒ | âŒ |
| ã‚µãƒ–ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ« | âœ… | âŒ | âŒ |
| è«‹æ±‚å±¥æ­´é–²è¦§ | âœ… | âŒ | âŒ |
| **ä¼šå“¡ç®¡ç†** | | | |
| ä¼šå“¡æ‰¿èª/æ‹’å¦ | âœ… | âœ… | âŒ |
| ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ | âœ… | âœ… | âŒ |
| ä¼šå“¡å½¹å‰²å¤‰æ›´ | âœ… | âœ… | âŒ |
| ä¼šå“¡å‰Šé™¤ | âœ… | âœ… | âŒ |
| **æŠ•ç¨¿ç®¡ç†** | | | |
| è‡ªåˆ†ã®æŠ•ç¨¿ä½œæˆ | âœ… | âœ… | âœ… |
| è‡ªåˆ†ã®æŠ•ç¨¿ç·¨é›† | âœ… | âœ… | âœ… |
| è‡ªåˆ†ã®æŠ•ç¨¿å‰Šé™¤ | âœ… | âœ… | âœ… |
| ä»–äººã®æŠ•ç¨¿ç·¨é›† | âœ… | âœ… | âŒ |
| ä»–äººã®æŠ•ç¨¿å‰Šé™¤ | âœ… | âœ… | âŒ |
| **ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†** | | | |
| è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ | âœ… | âœ… | âœ… |
| è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ | âœ… | âœ… | âœ… |
| ä»–äººã®ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ | âœ… | âœ… | âŒ |
| **ã„ã„ã­æ©Ÿèƒ½** | | | |
| ã„ã„ã­ | âœ… | âœ… | âœ… |
| ã„ã„ã­å–ã‚Šæ¶ˆã— | âœ… | âœ… | âœ… |
| **é€šçŸ¥** | | | |
| é€šçŸ¥å—ä¿¡ | âœ… | âœ… | âœ… |
| é€šçŸ¥é–²è¦§ | âœ… | âœ… | âœ… |
| **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨­å®š** | | | |
| åŸºæœ¬è¨­å®šå¤‰æ›´ | âœ… | âŒ | âŒ |
| ãƒ†ãƒ¼ãƒå¤‰æ›´ | âœ… | âŒ | âŒ |
| å…¬é–‹è¨­å®šå¤‰æ›´ | âœ… | âŒ | âŒ |

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®è€ƒãˆæ–¹

### 1. æœ€å°æ¨©é™ã®åŸå‰‡
å„ãƒ­ãƒ¼ãƒ«ã«ã¯å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ã‚’ä»˜ä¸

### 2. éšå±¤çš„æ¨©é™ç®¡ç†
ä¸Šä½ãƒ­ãƒ¼ãƒ«ã¯ä¸‹ä½ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’è‡ªå‹•çš„ã«ç¶™æ‰¿

### 3. è²¡å‹™æƒ…å ±ã®ä¿è­·
ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ»è«‹æ±‚æƒ…å ±ã¯ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### 4. æ‰€æœ‰æ¨©ã®ä¸å¤‰æ€§
ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ã¯å¤‰æ›´ä¸å¯ã§ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®æ‰€æœ‰ã‚’ä¿è¨¼

### 5. ç›£æŸ»è¨¼è·¡
ã™ã¹ã¦ã®æ¨©é™æ“ä½œã¯ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²å¯èƒ½ãªè¨­è¨ˆ

---

## ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿

### ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ä½œæˆæ™‚ã®è‡ªå‹•è¨­å®š

```typescript
// æ–°è¦ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ä½œæˆæ™‚
{
  tenants: {
    owner_user_id: user.id,  // ä½œæˆè€…ãŒã‚ªãƒ¼ãƒŠãƒ¼
    plan: 'free',            // åˆæœŸãƒ—ãƒ©ãƒ³ã¯Free
    status: 'active',        // å³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
    member_count: 1          // ã‚ªãƒ¼ãƒŠãƒ¼1äººã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
  },
  tenant_memberships: {
    role: 'owner',           // ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™
    member_number: '0',      // ç‰¹åˆ¥ç•ªå·
    status: 'active'         // æ‰¿èªä¸è¦
  }
}
```

### ä¸€èˆ¬çš„ãªæ§‹æˆä¾‹

| ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚µã‚¤ã‚º | Owner | Admin | Member | åˆè¨ˆ |
|---|---|---|---|---|
| å°è¦æ¨¡ | 1 | 0-1 | 10-50 | 11-52 |
| ä¸­è¦æ¨¡ | 1 | 2-5 | 50-500 | 53-506 |
| å¤§è¦æ¨¡ | 1 | 5-10 | 500+ | 506+ |

---

## ğŸš€ ã¾ã¨ã‚

### 3ã¤ã®ãƒ­ãƒ¼ãƒ«ã®é–¢ä¿‚æ€§

```
Ownerï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰
  â”œâ”€ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ä½œæˆè€…
  â”œâ”€ æœ€é«˜æ¨©é™ãƒ»å…¨æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹
  â”œâ”€ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ»è²¡å‹™ç®¡ç†
  â””â”€ å¤‰æ›´ä¸å¯ãƒ»1ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£1äºº

Adminï¼ˆç®¡ç†è€…ï¼‰
  â”œâ”€ ã‚ªãƒ¼ãƒŠãƒ¼ãŒä»»å‘½
  â”œâ”€ ä¼šå“¡ç®¡ç†ãƒ»æŠ•ç¨¿ç®¡ç†
  â”œâ”€ è¤‡æ•°äººè¨­å®šå¯èƒ½
  â””â”€ ã‚ªãƒ¼ãƒŠãƒ¼ãŒã„ã¤ã§ã‚‚å¤‰æ›´å¯èƒ½

Memberï¼ˆãƒ¡ãƒ³ãƒãƒ¼ï¼‰
  â”œâ”€ ä¸€èˆ¬å‚åŠ è€…
  â”œâ”€ æŠ•ç¨¿ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ã„ã„ã­
  â”œâ”€ æ‰¿èªåˆ¶
  â””â”€ åŸºæœ¬æ©Ÿèƒ½ã®ã¿
```

### è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

1. âœ… **æ˜ç¢ºãªéšå±¤æ§‹é€ **: Owner > Admin > Member
2. âœ… **æ¨©é™ã®ç¶™æ‰¿**: ä¸Šä½ãƒ­ãƒ¼ãƒ«ã¯ä¸‹ä½ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’æŒã¤
3. âœ… **è²¡å‹™æƒ…å ±ã®ä¿è­·**: ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ãŒç®¡ç†
4. âœ… **æŸ”è»Ÿãªç®¡ç†è€…ä»»å‘½**: ã‚ªãƒ¼ãƒŠãƒ¼ãŒè‡ªç”±ã«è¨­å®šå¯èƒ½
5. âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦–**: æœ€å°æ¨©é™ã®åŸå‰‡

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2026-01-05  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v1.0.0
