# 一般会員の利用フロー

## 概要

一般会員がコミュニティに参加してプランを選択するまでの完全なフローを説明します。

## フロー図

```
1. テナントホームにアクセス
   /tenant/home?subdomain=test
   ↓
2. 会員登録 or ログイン
   /register?subdomain=test
   /login?subdomain=test
   ↓
3. 認証完了・ホームページに戻る
   ナビゲーションメニューが表示される
   ↓
4. プラン選択へアクセス（3つの方法）
   a) ナビゲーションメニュー → 「プラン選択」
   b) ホームページのCTAバナー → 「プランを見る」ボタン
   c) 直接URL: /tenant/member-plans?subdomain=test
   ↓
5. 利用可能なプラン一覧を確認
   - プラン名
   - 料金
   - 説明
   - 特典
   ↓
6. プランを選択して「このプランを選択」ボタンをクリック
   ↓
7. 確認モーダルで内容を確認
   ↓
8. 「確定」ボタンをクリック
   ↓
9. Stripe Checkoutページにリダイレクト
   ↓
10. カード情報を入力して決済
   ↓
11. Webhook処理（バックグラウンド）
    - tenant_memberships.plan_id を更新
    - stripe_customer_id, stripe_subscription_id を保存
    ↓
12. 成功ページにリダイレクト
    「決済が完了しました！」メッセージ表示
```

## アクセス方法の詳細

### 1. ナビゲーションメニューから（推奨）

**デスクトップ**:
1. 右上のユーザーメニュー（ユーザー名）をクリック
2. ドロップダウンメニューから「プラン選択」を選択

**モバイル**:
1. 右上のハンバーガーメニュー（☰）をクリック
2. メニューから「プラン選択」をタップ

### 2. ホームページのCTAバナーから

ホームページの統計セクションの下に、目立つ青紫のグラデーションバナーが表示されます：

```
┌─────────────────────────────────────────┐
│        ⭐ (星のアイコン)                  │
│                                         │
│  プレミアムプランでもっと楽しもう！        │
│                                         │
│  限定コンテンツや特別な特典を             │
│  お楽しみいただけます                    │
│                                         │
│    [🏷️ プランを見る]                    │
└─────────────────────────────────────────┘
```

**特徴**:
- 認証済みユーザーにのみ表示
- 目立つデザインで視認性が高い
- ワンクリックでプラン選択ページへ

### 3. 直接URLから

会員が直接以下のURLにアクセス可能：
```
https://commons-webapp.pages.dev/tenant/member-plans?subdomain=test
```

## UI/UX の工夫

### 認証状態による表示切り替え

- **未認証ユーザー**: 
  - ログインボタンのみ表示
  - プラン選択CTAは非表示

- **認証済みユーザー**:
  - ユーザーメニュー表示（プロフィール、プラン選択、ログアウト）
  - プラン選択CTAバナー表示

### レスポンシブデザイン

- **デスクトップ**: ドロップダウンメニュー形式
- **モバイル**: 展開式メニュー形式
- すべてのデバイスで快適に操作可能

## プラン選択ページの機能

### 表示内容

1. **現在のプラン** (プラン適用済みの場合)
   - プラン名
   - 料金
   - 説明
   - 有効期限 or 継続中

2. **利用可能なプラン一覧**
   - カード形式で表示
   - プラン名・料金・説明・特典
   - 「このプランを選択」ボタン

### インタラクション

1. プラン選択ボタンをクリック
2. 確認モーダル表示
3. 内容確認後「確定」ボタン
4. Stripe Checkoutへ自動リダイレクト

## 実装されたページ一覧

| ページ | URL | 説明 |
|---|---|---|
| テナントホーム | `/tenant/home?subdomain=test` | コミュニティのトップページ |
| 会員登録 | `/register?subdomain=test` | 新規会員登録 |
| ログイン | `/login?subdomain=test` | 会員ログイン |
| プラン選択 | `/tenant/member-plans?subdomain=test` | **プラン選択・決済** |
| マイページ | `/tenant/mypage?subdomain=test` | プロフィール管理 |
| 投稿一覧 | `/tenant/posts?subdomain=test` | 投稿の閲覧 |

## トラブルシューティング

### プラン選択リンクが表示されない

**原因**: ログインしていない

**解決方法**:
1. `/login?subdomain=test` からログイン
2. ホームページに戻る
3. ナビゲーションメニューを確認

### プランが表示されない

**原因**: コミュニティ運営者がプランを作成していない

**解決方法**:
- コミュニティ運営者に連絡してプラン作成を依頼
- 運営者は `/tenant/plans?subdomain=test` からプラン作成可能

### 決済ページに進まない

**原因**: Stripe設定が未完了

**解決方法**:
- `STRIPE_SECRET_KEY` 環境変数を設定
- プラットフォーム管理者に連絡

## まとめ

一般会員がプランを選択するには、以下の3つの方法があります：

1. ✅ **ナビゲーションメニュー** - ユーザーメニューの「プラン選択」
2. ✅ **CTAバナー** - ホームページの目立つバナー
3. ✅ **直接URL** - `/tenant/member-plans?subdomain=test`

すべての方法でスムーズにプラン選択・決済ができるようになっています！
