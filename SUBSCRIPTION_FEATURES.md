# サブスクリプション機能一覧

## 概要

このドキュメントでは、コミュニティオーナーとメンバーそれぞれが利用できるサブスクリプション関連機能を整理しています。

---

## 🔑 役割（Role）の定義

| 役割 | 説明 | 権限レベル |
|---|---|---|
| **owner** | コミュニティオーナー（作成者） | 最高権限 |
| **admin** | 管理者 | 高権限 |
| **member** | 一般メンバー | 基本権限 |

---

## 👑 コミュニティオーナー（Owner）の機能

### 1. サブスクリプション管理ページ
**URL**: `/tenant/subscription?subdomain=test`  
**権限**: `owner` のみアクセス可能

#### 表示される情報
- ✅ **現在のプラン**: Free / Starter / Pro
- ✅ **サブスクリプションステータス**: アクティブ / 支払い遅延 / キャンセル済み など
- ✅ **次回更新日**: サブスクリプション期間終了日
- ✅ **キャンセル予定通知**: キャンセルが予定されている場合に表示
- ✅ **使用状況**:
  - メンバー数
  - ストレージ使用量（MB）
  - ストレージ上限（MB）
  - ストレージ使用率（プログレスバー）

#### 実行できるアクション
- ✅ **プラン変更（アップグレード/ダウングレード）**
  - Free → Starter / Pro
  - Starter → Pro / Free
  - Pro → Starter / Free
  - 既存サブスクがある場合は即座に変更
  - 新規サブスクの場合はStripe Checkoutへリダイレクト

- ✅ **サブスクリプションキャンセル**
  - デフォルト: 期間終了時にキャンセル（サービスは期間終了まで継続）
  - オプション: 即座にキャンセル（すぐにFreeプランへダウングレード）

- ✅ **キャンセル取り消し**
  - キャンセル予定のサブスクリプションを再開

- ✅ **請求履歴閲覧**
  - 過去100件の請求書を表示
  - 各請求書の詳細:
    - 請求書番号
    - 請求日
    - 金額
    - ステータス（支払い済み / 未払い）
    - PDF ダウンロードリンク
    - Stripe ホスト請求書URL

### 2. サブスクリプション管理API
**ベースURL**: `/api/subscription`

#### エンドポイント一覧

##### GET `/api/subscription/status`
- **権限**: owner のみ
- **機能**: サブスクリプション状態を取得
- **レスポンス**:
  - テナント情報（ID、サブドメイン、名前、ステータス）
  - プラン（free / starter / pro）
  - サブスクリプションステータス
  - 期間開始日・終了日
  - キャンセル予定日
  - トライアル終了日
  - 使用状況（メンバー数、ストレージ）
  - Stripe サブスクリプション詳細

##### POST `/api/subscription/change-plan`
- **権限**: owner のみ
- **機能**: プラン変更
- **パラメータ**: `{ plan: 'free' | 'starter' | 'pro' }`
- **動作**:
  - Freeプランへの変更: 既存サブスクをキャンセル予約
  - 有料プランへの変更: 既存サブスクを更新 or 新規Checkout作成

##### POST `/api/subscription/cancel`
- **権限**: owner のみ
- **機能**: サブスクリプションキャンセル
- **パラメータ**: `{ immediate: boolean }` (optional)
- **動作**:
  - `immediate: false`（デフォルト）: 期間終了時にキャンセル
  - `immediate: true`: 即座にキャンセル

##### POST `/api/subscription/reactivate`
- **権限**: owner のみ
- **機能**: キャンセル予定を取り消し
- **動作**: Stripeの `cancel_at_period_end` を `false` に設定

##### GET `/api/subscription/invoices`
- **権限**: owner のみ
- **機能**: 請求履歴を取得
- **レスポンス**: Stripeから過去100件の請求書データ

### 3. Stripe決済（Checkout）
**URL**: Stripe Checkoutページ（外部）

#### フロー
1. オーナーがプラン変更を選択
2. Stripe Checkoutセッションを作成（`/api/stripe/checkout`）
3. Stripeの決済ページへリダイレクト
4. 決済完了後、`/tenant/subscription/success?session_id=xxx&subdomain=test` へリダイレクト
5. Webhookが発火してデータベースを自動更新

### 4. Webhookによる自動更新
**URL**: `/api/stripe/webhook`  
**権限**: Stripeのみ（署名検証あり）

#### 処理されるイベント
- ✅ `checkout.session.completed`: 決済完了 → プラン自動アップグレード
- ✅ `customer.subscription.updated`: サブスク更新 → ステータス同期
- ✅ `customer.subscription.deleted`: サブスクキャンセル → 自動ダウングレード
- ✅ `invoice.payment_failed`: 支払い失敗 → ステータスを `past_due` に更新
- ✅ `invoice.payment_succeeded`: 支払い成功 → ステータスを `active` に更新

---

## 👥 一般メンバー（Member）の機能

### 現状の実装

**メンバー向けのサブスクリプション機能は実装されていません。**

メンバーは以下の情報にアクセス**できません**：
- ❌ コミュニティの現在のプラン
- ❌ サブスクリプションステータス
- ❌ 請求履歴
- ❌ プラン変更機能

### メンバーが間接的に影響を受ける部分

メンバーは以下の「プランによる制限」の影響を受けます：

#### プランによる制限（設計上）

| 項目 | Free | Starter | Pro |
|---|---|---|---|
| **メンバー数上限** | 50人 | 500人 | 無制限 |
| **ストレージ容量** | 1GB | 10GB | 100GB |

**注意**: 現在、これらの制限はデータベースに記録されていますが、アプリケーションレベルでの強制は未実装です。

#### メンバーができること（プランに関係なく）
- ✅ コミュニティに参加申請
- ✅ 投稿を閲覧
- ✅ 投稿を作成（管理者承認後）
- ✅ コメント投稿
- ✅ いいね機能
- ✅ 通知の受信

---

## 🔐 管理者（Admin）の機能

### 現状の実装

**管理者は一般メンバーと同じく、サブスクリプション管理機能にアクセスできません。**

管理者が持つ権限：
- ✅ 会員承認/拒否
- ✅ 会員ステータス変更（active / suspended）
- ✅ 会員役割変更（owner / admin / member）
- ✅ 投稿管理
- ✅ コメント管理

管理者が持たない権限：
- ❌ サブスクリプション管理
- ❌ プラン変更
- ❌ 請求履歴閲覧

---

## 📊 プラン比較表

| プラン | 月額 | メンバー上限 | ストレージ | 対象ユーザー |
|---|---|---|---|---|
| **Free** | ¥0 | 50人 | 1GB | 小規模コミュニティ |
| **Starter** | ¥980 | 500人 | 10GB | 成長中のコミュニティ |
| **Pro** | ¥2,980 | 無制限 | 100GB | 大規模コミュニティ |

---

## 🔄 サブスクリプションフロー図

### オーナーのフロー

```
1. オーナーがサブスクリプション管理ページにアクセス
   ↓
2. 現在のプラン・使用状況を確認
   ↓
3. プラン変更ボタンをクリック
   ↓
4-a. 既存サブスクがある場合
     → 即座に変更（APIで更新）
     
4-b. 新規サブスクの場合
     → Stripe Checkoutへリダイレクト
     → 決済完了後、Webhookでデータベース更新
   ↓
5. サブスクリプション管理ページに戻る
   ↓
6. 更新された情報を確認
```

### キャンセルフロー

```
1. オーナーが「キャンセル」ボタンをクリック
   ↓
2. 確認ダイアログ表示
   ↓
3. キャンセル実行（API呼び出し）
   ↓
4. Stripeで cancel_at_period_end = true に設定
   ↓
5. データベースに cancel_at を記録
   ↓
6. ページ再読み込み → キャンセル予定通知が表示
   ↓
7. 期間終了時にWebhookでFreeプランへ自動ダウングレード
```

---

## 🚀 今後の拡張案

### メンバー向け機能の追加案

#### 1. プラン情報の表示（読み取り専用）
- コミュニティのトップページに現在のプランバッジを表示
- 例: 「このコミュニティは Starter プランです」

#### 2. 制限到達時の通知
- メンバー数上限に近づいた時にメンバーに通知
- ストレージ容量不足時の警告

#### 3. プレミアム機能へのアクセス制御
- 特定の機能をProプラン限定にする
- 例: 動画投稿はProプランのみ

#### 4. メンバーからのプラン提案
- メンバーがオーナーにプランアップグレードを提案できる機能

### 管理者向け機能の追加案

#### 1. 使用状況の閲覧権限
- 管理者もストレージ使用量やメンバー数を確認できる
- ただしプラン変更・請求情報は閲覧不可

#### 2. 制限アラート
- メンバー数やストレージが上限に近づいた時に管理者に通知

---

## 📝 まとめ

### 現在実装されている機能

#### オーナー（Owner）
- ✅ サブスクリプション管理ページ（完全アクセス）
- ✅ プラン変更（アップグレード/ダウングレード）
- ✅ サブスクリプションキャンセル・再開
- ✅ 請求履歴閲覧
- ✅ 使用状況モニタリング
- ✅ Stripe決済フロー
- ✅ Webhook自動更新

#### 管理者（Admin）
- ❌ サブスクリプション関連機能なし
- ✅ 会員管理・投稿管理権限のみ

#### 一般メンバー（Member）
- ❌ サブスクリプション関連機能なし
- ✅ 通常のコミュニティ機能（投稿・コメント・いいね）

### 設計思想

**「コミュニティの財務管理はオーナーのみが行う」**

これにより：
- セキュリティ: 請求情報が適切に保護される
- シンプル: 権限管理が明確
- 責任の明確化: オーナーが支払い責任を負う

---

## 🔗 関連ファイル

### バックエンド
- `src/routes/subscription.ts` - サブスクリプション管理API
- `src/routes/stripe.ts` - Stripe決済・Webhook
- `migrations/0004_add_subscription_fields.sql` - サブスク関連DBスキーマ

### フロントエンド
- `src/routes/tenant-public.ts` - サブスクリプション管理UI（5200行目付近）

### ドキュメント
- `README.md` - プロジェクト全体の概要
- `SUBSCRIPTION_FEATURES.md` - このドキュメント

---

**最終更新日**: 2026-01-05  
**バージョン**: v1.0.0
