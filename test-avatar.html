<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像アップロードテスト</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">画像アップロードテスト</h1>
        
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-2">1. ログイン</h2>
            <div class="space-y-2">
                <input type="email" id="email" placeholder="メールアドレス" class="w-full px-4 py-2 border rounded">
                <input type="password" id="password" placeholder="パスワード" class="w-full px-4 py-2 border rounded">
                <button onclick="login()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ログイン
                </button>
            </div>
            <div id="loginStatus" class="mt-2 text-sm"></div>
        </div>

        <div id="uploadSection" class="hidden">
            <h2 class="text-lg font-semibold mb-2">2. 画像アップロード</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">アバター画像を選択</label>
                    <input type="file" id="avatarFile" accept="image/*" class="w-full px-4 py-2 border rounded">
                </div>
                <button onclick="uploadAvatar()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    アップロード
                </button>
            </div>
            <div id="uploadStatus" class="mt-2 text-sm"></div>
            <div id="preview" class="mt-4"></div>
        </div>
    </div>

    <script>
        let token = null;

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    statusDiv.innerHTML = '<p class="text-green-600">✅ ログイン成功！</p>';
                    document.getElementById('uploadSection').classList.remove('hidden');
                } else {
                    statusDiv.innerHTML = `<p class="text-red-600">❌ ${data.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-600">❌ エラー: ${error.message}</p>`;
            }
        }

        async function uploadAvatar() {
            const fileInput = document.getElementById('avatarFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const previewDiv = document.getElementById('preview');

            if (!file) {
                statusDiv.innerHTML = '<p class="text-red-600">ファイルを選択してください</p>';
                return;
            }

            if (!token) {
                statusDiv.innerHTML = '<p class="text-red-600">先にログインしてください</p>';
                return;
            }

            // ファイルサイズチェック
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                statusDiv.innerHTML = '<p class="text-red-600">ファイルサイズは5MB以下にしてください</p>';
                return;
            }

            statusDiv.innerHTML = '<p class="text-blue-600">アップロード中...</p>';

            try {
                const formData = new FormData();
                formData.append('avatar', file);

                const response = await fetch('/api/upload/avatar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `
                        <p class="text-green-600">✅ アップロード成功！</p>
                        <p class="text-gray-600 mt-1">URL: ${data.avatar_url}</p>
                    `;
                    
                    // プレビュー表示
                    previewDiv.innerHTML = `
                        <div class="border rounded p-4">
                            <p class="font-semibold mb-2">アップロードされた画像:</p>
                            <img src="${data.avatar_url}" alt="Avatar" class="w-32 h-32 rounded-full object-cover">
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<p class="text-red-600">❌ ${data.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-600">❌ エラー: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
